<div class="profile-container">
  <!-- Breadcrumbs -->
  <div class="profile-breadcrumb">
    <app-breadcrumbs [crumbs]="[
      { label: 'Home', link: '/' },
      { label: 'Profile' }
    ]"></app-breadcrumbs>
  </div>

  <!-- Profile Header Section -->
  <div class="profile-header-section">
    <!-- Header Buttons -->
    <div class="header-buttons">
      <button *ngIf="!isEditing" class="btn-edit" (click)="toggleEdit()">
        <lucide-icon [img]="Edit" [size]="18"></lucide-icon>
        Edit Profile
      </button>
    </div>

    <div class="profile-cover" [class.has-custom]="coverPreviewUrl || user.coverPhoto">
      <img
        *ngIf="(coverPreviewUrl || user.coverPhoto) && !coverFailed"
        [src]="coverPreviewUrl || user.coverPhoto"
        (error)="onCoverError($event)"
        alt="Cover"
        class="cover-img"
      />
      <div *ngIf="!coverPreviewUrl && !user.coverPhoto || coverFailed" class="default-cover">
        <div class="cover-gradient"
          [ngStyle]="{'background': themeService.isDarkMode()
            ? 'linear-gradient(135deg, #0a0a0a 0%, #121212 25%, #0d0d0d 50%, #050505 100%)'
            : 'linear-gradient(135deg, #f8fafc 0%, #e2e8f0 25%, #f1f5f9 50%, #e8edf5 100%)'}"
        ></div>
        <div class="cover-grid-pattern">
          <svg class="grid-svg" viewBox="0 0 800 200" preserveAspectRatio="xMidYMid slice">
            <defs>
              <pattern id="grid-profile" width="15" height="15" patternUnits="userSpaceOnUse">
                <rect width="15" height="15" fill="none"
                  [attr.stroke]="themeService.isDarkMode() ? 'rgba(251,191,36,0.15)' : 'rgba(180,120,0,0.3)'"
                  stroke-width="0.5"/>
              </pattern>
            </defs>
            <rect width="800" height="200" fill="url(#grid-profile)" />
          </svg>
        </div>
        <div class="cover-stars">
          <div *ngFor="let star of starPositions" class="floating-star" [style.left.%]="star.left" [style.top.%]="star.top" [style.animation-delay.s]="star.delay">
            <lucide-icon [img]="Star" [size]="star.size"></lucide-icon>
          </div>
        </div>
        <div class="cover-logo-corner">
          <img *ngIf="themeService.isDarkMode()" src="/LOGO_WHITE.png" alt="RateOn" />
          <img *ngIf="!themeService.isDarkMode()" src="/LOGO_BLACK.png" alt="RateOn" />
        </div>
      </div>
      <label *ngIf="isEditing" for="cover-input" class="btn-upload-cover" title="Change cover photo">
        <lucide-icon [img]="Camera" [size]="20"></lucide-icon>
        <span>Change Cover</span>
      </label>
      <input
        id="cover-input"
        type="file"
        accept="image/*"
        (change)="onCoverFileSelected($event)"
        style="display: none;"
      />
    </div>

    <div class="profile-main">
      <div class="avatar-section">
        <div class="avatar-wrapper">
          <img *ngIf="previewUrl" [src]="previewUrl" alt="Preview" class="avatar-img" />
          <img
            *ngIf="!previewUrl && user.avatar && !avatarFailed"
            [src]="user.avatar"
            (error)="onAvatarError($event)"
            alt="Avatar"
            class="avatar-img"
            referrerpolicy="no-referrer"
            crossorigin="anonymous"
          />
          <div *ngIf="!previewUrl && (!user.avatar || avatarFailed)" class="avatar-placeholder">{{ getInitial() }}</div>
          <label *ngIf="isEditing" for="avatar-input" class="btn-upload-avatar" title="Change avatar">
            <lucide-icon [img]="Camera" [size]="16"></lucide-icon>
          </label>
          <input
            id="avatar-input"
            type="file"
            accept="image/*"
            (change)="onFileSelected($event)"
            style="display: none;"
          />
        </div>
      </div>
      <div class="profile-info">
        <h1 class="profile-name">
          {{ user.firstName || user.username }}
          <span *ngIf="user.lastName">{{ user.lastName }}</span>
        </h1>
        <p class="profile-username">@{{ user.username }}</p>
        <div class="profile-badges">
          <span class="level-badge">{{ user.level }}</span>
          <span class="role-badge">{{ user.role }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Grid -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon trust"><lucide-icon [img]="Shield" [size]="24"></lucide-icon></div>
      <div class="stat-content">
        <p class="stat-value">{{ user.trustScore || 0 }}</p>
        <p class="stat-label">Trust Score</p>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon reviews"><lucide-icon [img]="FileText" [size]="24"></lucide-icon></div>
      <div class="stat-content">
        <p class="stat-value">{{ user.totalReviews || 0 }}</p>
        <p class="stat-label">Reviews</p>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon followers"><lucide-icon [img]="Users" [size]="24"></lucide-icon></div>
      <div class="stat-content">
        <p class="stat-value">{{ user.totalFollowers || 0 }}</p>
        <p class="stat-label">Followers</p>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon following"><lucide-icon [img]="UserPlus" [size]="24"></lucide-icon></div>
      <div class="stat-content">
        <p class="stat-value">{{ user.totalFollowing || 0 }}</p>
        <p class="stat-label">Following</p>
      </div>
    </div>
  </div>

  <!-- Profile Card -->
  <div class="profile-card">
    <div class="profile-details">
      <h2>Profile Information</h2>
      <div *ngIf="!isEditing" class="details-view">
        <div class="detail-item">
          <lucide-icon [img]="Mail" [size]="20"></lucide-icon>
          <div class="detail-content">
            <span class="detail-label">Email</span>
            <span class="detail-value">{{ user.email }}</span>
          </div>
        </div>
        <div class="detail-item" *ngIf="user.phone">
          <lucide-icon [img]="Phone" [size]="20"></lucide-icon>
          <div class="detail-content">
            <span class="detail-label">Phone</span>
            <span class="detail-value">{{ user.phone }}</span>
          </div>
        </div>
        <div class="detail-item" *ngIf="user.location">
          <lucide-icon [img]="MapPin" [size]="20"></lucide-icon>
          <div class="detail-content">
            <span class="detail-label">Location</span>
            <span class="detail-value">{{ user.location }}</span>
          </div>
        </div>
        <div class="detail-item full-width" *ngIf="user.bio">
          <lucide-icon [img]="FileText" [size]="20"></lucide-icon>
          <div class="detail-content">
            <span class="detail-label">Bio</span>
            <span class="detail-value bio">{{ user.bio }}</span>
          </div>
        </div>
        <div class="detail-item full-width" *ngIf="!user.bio && !user.phone && !user.location">
          <p class="empty-message">Complete your profile to help others get to know you better!</p>
        </div>
      </div>
      <div *ngIf="isEditing" class="details-edit">
        <div class="form-row">
          <div class="form-group">
            <label>First Name</label>
            <input type="text" [(ngModel)]="editForm.firstName" placeholder="Enter first name" />
          </div>
          <div class="form-group">
            <label>Last Name</label>
            <input type="text" [(ngModel)]="editForm.lastName" placeholder="Enter last name" />
          </div>
        </div>
        <div class="form-group">
          <label>Bio</label>
          <textarea [(ngModel)]="editForm.bio" placeholder="Tell us about yourself..." rows="3"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Phone</label>
            <input type="tel" [(ngModel)]="editForm.phone" placeholder="+91 1234567890" />
          </div>
          <div class="form-group">
            <label>Location</label>
            <input type="text" [(ngModel)]="editForm.location" placeholder="City, Country" />
          </div>
        </div>
        <div class="form-actions">
          <button class="btn-save" (click)="saveProfile()" [disabled]="saving">
            <lucide-icon *ngIf="!saving" [img]="Check" [size]="18"></lucide-icon>
            {{ saving ? 'Saving...' : 'Save Changes' }}
          </button>
          <button class="btn-cancel" (click)="toggleEdit()" [disabled]="saving">
            <lucide-icon [img]="X" [size]="18"></lucide-icon>
            Cancel
          </button>
        </div>
      </div>
    </div>
    <div class="convert-business" *ngIf="!isEditing && user.role === 'Reviewer'">
      <div class="cb-left">
        <div class="cb-icon"><lucide-icon [img]="Building2" [size]="28"></lucide-icon></div>
        <div class="cb-info">
          <h3>Become a Business</h3>
          <p>Register your business, respond to reviews &amp; manage your brand reputation.</p>
        </div>
      </div>
      <button class="btn-convert" (click)="convertToBusiness()" [disabled]="converting">
        <span>{{ converting ? 'Converting...' : 'Get Started' }}</span>
        <lucide-icon *ngIf="!converting" [img]="ChevronRight" [size]="18"></lucide-icon>
      </button>
    </div>
    <div class="danger-zone" *ngIf="!isEditing">
      <div class="danger-content">
        <div class="danger-info">
          <h3>Delete Account</h3>
          <p>Once you delete your account, there is no going back. All your data will be permanently deleted.</p>
        </div>
        <button class="btn-delete" (click)="openDeleteModal()">
          <lucide-icon [img]="Trash2" [size]="18"></lucide-icon>
          Delete Account
        </button>
      </div>
    </div>
  </div>

</div>

<!-- Delete Confirmation Modal -->
<div *ngIf="showDeleteModal" class="modal-overlay" (click)="closeDeleteModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Delete Account</h3>
      <p class="danger-text">This action cannot be undone!</p>
    </div>
    <p class="modal-warning">
      Are you sure you want to permanently delete your account? All your reviews, stats, and data will be lost forever.
    </p>
    <div class="modal-actions">
      <button class="btn-modal-danger" (click)="confirmDelete()" [disabled]="deleting">
        {{ deleting ? 'Deleting...' : 'Delete Account' }}
      </button>
      <button class="btn-modal-cancel" (click)="closeDeleteModal()" [disabled]="deleting">
        Cancel
      </button>
    </div>
  </div>
</div>
