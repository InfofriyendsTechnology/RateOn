<div class="dashboard">
  <div class="container">
    <!-- Header Section with Gradient -->
    <div class="dashboard-header">
      <div class="gradient-bg"></div>
      <div class="header-content">
        <div class="user-info">
          <div class="avatar-wrapper">
            <div class="avatar">
              <img *ngIf="user.avatar && !avatarFailed" [src]="user.avatar" [alt]="user.username" 
                   class="avatar-img" crossorigin="anonymous" referrerpolicy="no-referrer" (error)="onAvatarError($event)" />
              <span *ngIf="!user.avatar || avatarFailed" class="avatar-initial">{{ user.username.charAt(0).toUpperCase() }}</span>
            </div>
            <div class="trust-badge" [class.high]="user.trustScore >= 80" [class.medium]="user.trustScore >= 50 && user.trustScore < 80">
              <lucide-icon [img]="Shield" [size]="16"></lucide-icon>
              <span>{{ user.trustScore }}</span>
            </div>
          </div>
          <div class="user-details">
            <h1 class="welcome-text">Welcome back, <span class="name-highlight">{{ user.firstName || user.username }}</span>! üëã</h1>
            <p class="email">{{ user.email }}</p>
            <div class="badges">
              <span class="level-badge" [ngClass]="getLevelClass(user.level)">
                <lucide-icon [img]="Star" [size]="14"></lucide-icon>
                {{ user.level }}
              </span>
              <span class="role-badge">
                <lucide-icon [img]="User" [size]="14"></lucide-icon>
                {{ user.role }}
              </span>
            </div>
          </div>
        </div>
        <button class="edit-profile-btn" (click)="navigateToProfile()">
          <lucide-icon [img]="Edit" [size]="18"></lucide-icon>
          Edit Profile
        </button>
      </div>
    </div>

    <!-- Trust Score & Stats Combined -->
    <div class="overview-section">
      <!-- Trust Score Card -->
      <div class="trust-score-card glass-card">
        <div class="card-header">
          <h2>
            <lucide-icon [img]="Shield" [size]="20"></lucide-icon>
            Trust Score
          </h2>
          <span class="trend-indicator positive">
            <lucide-icon [img]="TrendingUp" [size]="14"></lucide-icon>
            +5 this week
          </span>
        </div>
        <div class="trust-content">
          <div class="trust-circle">
            <svg viewBox="0 0 160 160">
              <defs>
                <linearGradient id="trustGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" [attr.stop-color]="getTrustColor()" stop-opacity="0.3"/>
                  <stop offset="100%" [attr.stop-color]="getTrustColor()" stop-opacity="1"/>
                </linearGradient>
              </defs>
              <circle class="circle-bg" cx="80" cy="80" r="70" />
              <circle 
                class="circle-progress" 
                cx="80" 
                cy="80" 
                r="70"
                [attr.stroke]="'url(#trustGradient)'"
                [attr.stroke-dasharray]="getTrustScoreCircumference()"
                [attr.stroke-dashoffset]="getTrustScoreOffset()"
              />
            </svg>
            <div class="trust-score-value">
              <span class="score">{{ user.trustScore }}</span>
              <span class="max">/100</span>
              <p class="score-label">{{ getTrustLabel() }}</p>
            </div>
          </div>
          <div class="trust-breakdown">
            <div class="breakdown-item">
              <div class="breakdown-icon reviews">
                <lucide-icon [img]="FileText" [size]="18"></lucide-icon>
              </div>
              <div class="breakdown-info">
                <span class="label">From Reviews</span>
                <span class="value">+{{ getTrustFromReviews() }} points</span>
              </div>
            </div>
            <div class="breakdown-item">
              <div class="breakdown-icon reactions">
                <lucide-icon [img]="ThumbsUp" [size]="18"></lucide-icon>
              </div>
              <div class="breakdown-info">
                <span class="label">From Reactions</span>
                <span class="value">+{{ getTrustFromReactions() }} points</span>
              </div>
            </div>
            <div class="breakdown-item">
              <div class="breakdown-icon engagement">
                <lucide-icon [img]="Users" [size]="18"></lucide-icon>
              </div>
              <div class="breakdown-info">
                <span class="label">From Social</span>
                <span class="value">+{{ getTrustFromSocial() }} points</span>
              </div>
            </div>
          </div>
        </div>
        <div class="trust-footer">
          <p>üí° Keep reviewing to reach <strong>{{ getNextLevel() }}</strong> level!</p>
        </div>
      </div>

      <!-- Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card glass-card" *ngFor="let stat of stats" [ngClass]="stat.icon">
          <div class="stat-icon-wrapper">
            <div class="stat-icon">
              <lucide-icon 
                *ngIf="stat.icon === 'reviews'" 
                [img]="FileText" 
                [size]="24" 
                [strokeWidth]="2">
              </lucide-icon>
              <lucide-icon 
                *ngIf="stat.icon === 'followers'" 
                [img]="Users" 
                [size]="24" 
                [strokeWidth]="2">
              </lucide-icon>
              <lucide-icon 
                *ngIf="stat.icon === 'following'" 
                [img]="UserPlus" 
                [size]="24" 
                [strokeWidth]="2">
              </lucide-icon>
              <lucide-icon 
                *ngIf="stat.icon === 'helpful'" 
                [img]="ThumbsUp" 
                [size]="24" 
                [strokeWidth]="2">
              </lucide-icon>
            </div>
          </div>
          <div class="stat-content">
            <h3 class="stat-value">{{ stat.value }}</h3>
            <p class="stat-label">{{ stat.label }}</p>
            <span class="stat-trend" *ngIf="stat.trend">
              <lucide-icon [img]="TrendingUp" [size]="12" [strokeWidth]="3"></lucide-icon>
              {{ stat.trend }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
      <h2 class="section-title">
        <lucide-icon [img]="Check" [size]="20"></lucide-icon>
        Quick Actions
      </h2>
      <div class="actions-grid">
        <button class="action-btn" (click)="writeReview()">
          <div class="action-icon write">
            <lucide-icon [img]="Edit" [size]="22" [strokeWidth]="2"></lucide-icon>
          </div>
          <div class="action-content">
            <span class="action-title">Write Review</span>
            <span class="action-desc">Share your experience</span>
          </div>
        </button>
        <button class="action-btn" (click)="discoverPlaces()">
          <div class="action-icon discover">
            <lucide-icon [img]="Search" [size]="22" [strokeWidth]="2"></lucide-icon>
          </div>
          <div class="action-content">
            <span class="action-title">Discover Places</span>
            <span class="action-desc">Find new businesses</span>
          </div>
        </button>
        <button class="action-btn" (click)="openSettings()">
          <div class="action-icon settings">
            <lucide-icon [img]="Settings" [size]="22" [strokeWidth]="2"></lucide-icon>
          </div>
          <div class="action-content">
            <span class="action-title">Settings</span>
            <span class="action-desc">Manage preferences</span>
          </div>
        </button>
        <button class="action-btn" (click)="navigateToProfile()">
          <div class="action-icon profile">
            <lucide-icon [img]="User" [size]="22" [strokeWidth]="2"></lucide-icon>
          </div>
          <div class="action-content">
            <span class="action-title">View Profile</span>
            <span class="action-desc">See public profile</span>
          </div>
        </button>
      </div>
    </div>

    <!-- Recent Reviews -->
    <div class="recent-activity">
      <div class="section-header">
        <h2>Recent Reviews</h2>
        <a routerLink="/user/profile" class="view-all">View All ‚Üí</a>
      </div>
      
      <div *ngIf="loadingReviews" class="loading">
        <div class="spinner"></div>
      </div>
      
      <div *ngIf="!loadingReviews && recentReviews.length === 0" class="activity-placeholder">
        <p>üìù You haven't written any reviews yet</p>
        <button class="primary-btn" (click)="writeReview()">Write Your First Review</button>
      </div>
      
      <div *ngIf="!loadingReviews && recentReviews.length > 0" class="reviews-list">
        <div *ngFor="let review of recentReviews" class="review-card">
          <div class="review-header">
            <div class="review-meta">
              <h3 class="item-name">{{review.itemId?.name || 'Item'}}</h3>
              <p class="business-name" (click)="viewBusiness(review.businessId?._id || review.businessId)">
                <lucide-icon [img]="Building2" [size]="14" [strokeWidth]="2"></lucide-icon>
                {{review.businessId?.name || 'Business'}}
              </p>
            </div>
            <div class="review-rating">
              <div class="stars">
                <span *ngFor="let star of getRatingArray(review.rating)" class="star filled">‚òÖ</span>
                <span *ngFor="let star of getEmptyStars(review.rating)" class="star empty">‚òÜ</span>
              </div>
            </div>
          </div>
          
          <p class="review-text">{{review.comment}}</p>
          
          <div class="review-images" *ngIf="review.images?.length">
            <img *ngFor="let img of review.images.slice(0, 3)" [src]="img" alt="Review image" />
          </div>
          
          <div class="review-footer">
            <span class="review-date">{{formatDate(review.createdAt)}}</span>
            <div class="review-stats">
              <span class="stat" *ngIf="review.reactions?.helpful">
                üëç {{review.reactions.helpful}}
              </span>
              <span class="stat" *ngIf="review.ownerReply">
                üí¨ Owner replied
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
