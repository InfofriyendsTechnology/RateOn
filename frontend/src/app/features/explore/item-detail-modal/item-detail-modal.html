<div class="modal-overlay" (click)="close()" *ngIf="item">
  <div class="modal-container" (click)="onModalContentClick($event)">
    <!-- Close Button -->
    <button class="close-btn" (click)="close()" aria-label="Close modal">
      <lucide-icon [img]="X" [size]="24"></lucide-icon>
    </button>

    <!-- Modal Content -->
    <div class="modal-content">
      <!-- Image Gallery -->
      <div class="image-gallery">
        <div class="main-image">
          <img 
            [src]="item.images[currentImageIndex] || 'assets/placeholder-item.jpg'" 
            [alt]="item.name"
          />
          
          <!-- Navigation Arrows -->
          <button 
            class="nav-btn prev-btn" 
            (click)="previousImage()"
            *ngIf="item.images && item.images.length > 1"
            aria-label="Previous image"
          >
            <lucide-icon [img]="ChevronLeft" [size]="24"></lucide-icon>
          </button>
          <button 
            class="nav-btn next-btn" 
            (click)="nextImage()"
            *ngIf="item.images && item.images.length > 1"
            aria-label="Next image"
          >
            <lucide-icon [img]="ChevronRight" [size]="24"></lucide-icon>
          </button>
        </div>

        <!-- Thumbnail Strip -->
        <div class="thumbnails" *ngIf="item.images && item.images.length > 1">
          <div 
            *ngFor="let img of item.images; let i = index"
            class="thumbnail"
            [class.active]="i === currentImageIndex"
            (click)="selectImage(i)"
          >
            <img [src]="img" [alt]="item.name">
          </div>
        </div>
      </div>

      <!-- Item Info -->
      <div class="item-info">
        <!-- Header -->
        <div class="item-header">
          <div>
            <h2>{{item.name}}</h2>
            <p class="category">{{item.category}}</p>
          </div>
          
          <span class="availability-badge" [class]="getAvailabilityClass()">
            {{getAvailabilityText()}}
          </span>
        </div>

        <!-- Price & Rating -->
        <div class="price-rating">
          <div class="price" *ngIf="item.price">
            <lucide-icon [img]="DollarSign" [size]="20"></lucide-icon>
            <span>₹{{item.price}}</span>
          </div>
          
          <div class="rating">
            <div class="stars">
              <span *ngFor="let star of getRatingArray(item.averageRating)" class="star filled">★</span>
              <span *ngIf="hasHalfStar(item.averageRating)" class="star half">★</span>
              <span *ngFor="let star of getEmptyStars(item.averageRating)" class="star empty">☆</span>
            </div>
            <span class="rating-text">{{item.averageRating | number:'1.1-1'}} ({{reviews.length}} reviews)</span>
          </div>
        </div>

        <!-- Description -->
        <div class="description" *ngIf="item.description">
          <h3>Description</h3>
          <p>{{item.description}}</p>
        </div>

        <!-- Availability Note -->
          <div class="availability-note" *ngIf="item.availability && item.availability.note">
          <lucide-icon [img]="Clock" [size]="16"></lucide-icon>
          <span>{{item.availability.note}}</span>
        </div>

        <!-- Rating Distribution -->
        <div class="rating-distribution">
          <h3>Rating Breakdown</h3>
          <div class="distribution-list">
            <div class="distribution-item" *ngFor="let rating of [5, 4, 3, 2, 1]">
              <div class="rating-label">
                <span class="star-icon">★</span>
                <span>{{rating}}</span>
              </div>
              <div class="bar-container">
                <div class="bar" [style.width.%]="getRatingPercentage(rating)"></div>
              </div>
              <span class="count">{{getRatingCount(rating)}}</span>
            </div>
          </div>
        </div>

        <!-- Reviews Section -->
        <div class="reviews-section">
          <div class="reviews-header">
            <h3>Reviews ({{reviews.length}})</h3>
            <button 
              [class]="hasUserReview ? 'btn-secondary' : 'btn-primary'" 
              (click)="writeReview()"
            >
              {{getReviewButtonText()}}
            </button>
          </div>

          <!-- Loading State -->
          <div *ngIf="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading reviews...</p>
          </div>

          <!-- No Reviews -->
          <div *ngIf="!loading && reviews.length === 0" class="no-reviews">
            <p>No reviews yet. Be the first to review this item!</p>
            <button class="btn-secondary" (click)="writeReview()">
              Write the First Review
            </button>
          </div>

          <!-- Reviews List -->
          <div *ngIf="!loading && reviews.length > 0" class="reviews-list">
            <div 
              *ngFor="let review of reviews" 
              class="review-card"
              [class.user-review]="currentUser && (review.userId?._id === currentUser._id || review.userId === currentUser._id)"
            >
              <div class="review-header">
                <div class="user-info">
                  <img 
                    [src]="review.userId?.profile?.avatar || 'assets/default-avatar.png'" 
                    [alt]="review.userId?.username"
                    class="user-avatar"
                  />
                  <div>
                    <h4>{{review.userId?.username || 'Anonymous'}}</h4>
                    <span class="review-date">{{formatDate(review.createdAt)}}</span>
                  </div>
                </div>
                
                <div class="stars">
                  <span *ngFor="let star of getRatingArray(review.rating)" class="star filled">★</span>
                  <span *ngFor="let star of getEmptyStars(review.rating)" class="star empty">☆</span>
                </div>
              </div>

              <p class="review-text">{{review.comment}}</p>

              <!-- Review Images -->
              <div class="review-images" *ngIf="review.images && review.images.length > 0">
                <img 
                  *ngFor="let img of review.images.slice(0, 3)" 
                  [src]="img" 
                  alt="Review image"
                  class="review-image"
                />
              </div>

              <!-- Owner Response -->
              <div class="owner-response" *ngIf="review.ownerResponse">
                <p class="response-label">Response from owner:</p>
                <p class="response-text">{{review.ownerResponse.comment}}</p>
                <span class="response-date">{{formatDate(review.ownerResponse.respondedAt)}}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
