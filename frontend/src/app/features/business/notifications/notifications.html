<div class="notifications-container">
  <!-- Header -->
  <div class="notifications-header">
    <div class="header-content">
      <h1>Notifications</h1>
      <p>Stay updated with your business activities</p>
    </div>
    
    <div class="header-actions">
      <button 
        class="btn-mark-all" 
        (click)="markAllAsRead()" 
        *ngIf="unreadCount > 0"
        [disabled]="markingAll">
        <lucide-icon [img]="CheckCheck" [size]="18"></lucide-icon>
        <span>Mark all as read</span>
      </button>
    </div>
  </div>

  <!-- Stats Bar -->
  <div class="notifications-stats">
    <div class="stat-item">
      <span class="stat-value">{{ notifications.length }}</span>
      <span class="stat-label">Total</span>
    </div>
    <div class="stat-item unread">
      <span class="stat-value">{{ unreadCount }}</span>
      <span class="stat-label">Unread</span>
    </div>
    <div class="stat-item">
      <span class="stat-value">{{ todayCount }}</span>
      <span class="stat-label">Today</span>
    </div>
  </div>

  <!-- Filter Tabs -->
  <div class="filter-tabs">
    <button 
      class="tab-btn" 
      [class.active]="filterType === 'all'"
      (click)="setFilter('all')">
      All
    </button>
    <button 
      class="tab-btn" 
      [class.active]="filterType === 'unread'"
      (click)="setFilter('unread')">
      Unread
      <span class="count-badge" *ngIf="unreadCount > 0">{{ unreadCount }}</span>
    </button>
  </div>

  <!-- Notifications List -->
  <div class="notifications-list" *ngIf="!loading && filteredNotifications.length > 0">
    <div 
      class="notification-item" 
      *ngFor="let notification of filteredNotifications"
      [class.unread]="!notification.isRead"
      (click)="handleNotificationClick(notification)">
      
      <!-- User Avatar -->
      <div class="notification-avatar" [attr.data-initial]="getUserName(notification).charAt(0).toUpperCase()">
        <img *ngIf="getUserAvatar(notification) && !avatarFailed[notification._id]" 
             [src]="getUserAvatar(notification)" 
             [alt]="getUserName(notification)"
             class="avatar-image"
             crossorigin="anonymous"
             referrerpolicy="no-referrer"
             (error)="onAvatarError(notification._id)" />
        <span *ngIf="!getUserAvatar(notification) || avatarFailed[notification._id]" class="avatar-initial">
          {{ getUserName(notification).charAt(0).toUpperCase() || 'U' }}
        </span>
        <div class="notification-type-badge" [class]="getNotificationIconClass(notification.type)">
          <lucide-icon [img]="getNotificationIcon(notification.type)" [size]="12"></lucide-icon>
        </div>
      </div>
      
      <div class="notification-content">
        <div class="notification-header">
          <div class="notification-user-info">
            <h4 class="notification-user-name">{{ getUserName(notification) }}</h4>
            <span class="notification-action-type">{{ getActionText(notification.type) }}</span>
          </div>
          <span class="notification-time">{{ getTimeAgo(notification.createdAt) }}</span>
        </div>
        
        <p class="notification-message">{{ notification.message }}</p>
        
        <!-- Rating Stars for Review Notifications -->
        <div class="notification-rating" *ngIf="notification.metadata?.rating">
          <span *ngFor="let i of [1,2,3,4,5]" 
            class="star"
            [class.filled]="i <= notification.metadata.rating"
            [class.empty]="i > notification.metadata.rating">
            â˜…
          </span>
        </div>
        
        <div class="notification-meta" *ngIf="notification.metadata">
          <span class="meta-badge" *ngIf="notification.metadata.businessName">
            <lucide-icon [img]="ShoppingBag" [size]="12"></lucide-icon>
            {{ notification.metadata.businessName }}
          </span>
        </div>
        
        <!-- Reaction Buttons for Review Notifications -->
        <div class="notification-reactions" *ngIf="isReviewNotification(notification) && hasReviewId(notification)" (click)="$event.stopPropagation()">
          <app-reaction-buttons
            [reviewId]="notification.metadata.reviewId"
            [reviewOwnerId]="getReviewOwnerId(notification)"
            [initialStats]="getReactionStats(notification)"
            [userReaction]="getUserReaction(notification)"
            [compact]="true"
            (reactionChanged)="onReactionChanged(notification, $event)">
          </app-reaction-buttons>
        </div>
        
        <!-- Reply Count Badge -->
        <div class="notification-reply-count" *ngIf="getReplyCount(notification) > 0">
          <lucide-icon [img]="MessageSquare" [size]="14"></lucide-icon>
          <span>{{ getReplyCount(notification) }} {{ getReplyCount(notification) === 1 ? 'Reply' : 'Replies' }}</span>
        </div>
        
        <!-- Existing Reply Display -->
        <div class="notification-reply-display" *ngIf="hasReply(notification)">
          <div class="reply-indicator">
            <lucide-icon [img]="MessageSquare" [size]="14"></lucide-icon>
            <span>Latest Reply</span>
          </div>
          <p class="reply-text">{{ notification.metadata.replies[0].comment || notification.metadata.replies[0].text }}</p>
          <span class="reply-time">{{ getTimeAgo(notification.metadata.replies[0].createdAt) }}</span>
        </div>
        
        <!-- Reply Form -->
        <div class="notification-reply-form" *ngIf="isReviewNotification(notification) && replyingToNotification === notification._id" (click)="$event.stopPropagation()">
          <textarea 
            class="reply-input" 
            [(ngModel)]="replyText[notification._id]" 
            placeholder="Write your reply as business owner..."
            rows="3"
            [disabled]="submittingReply"
            (click)="$event.stopPropagation()">
          </textarea>
          <div class="reply-actions">
            <button class="btn-cancel" (click)="cancelReply(notification._id, $event)" [disabled]="submittingReply">
              Cancel
            </button>
            <button class="btn-submit" (click)="submitReply(notification, $event)" [disabled]="submittingReply || !replyText[notification._id]?.trim()">
              {{ submittingReply ? 'Sending...' : 'Send Reply' }}
            </button>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="notification-action-buttons" *ngIf="isReviewNotification(notification)">
          <button class="btn-action-primary" *ngIf="!hasReply(notification) && replyingToNotification !== notification._id" (click)="startReply(notification._id, $event)">
            <lucide-icon [img]="Reply" [size]="14"></lucide-icon>
            <span>Reply</span>
          </button>
          <button class="btn-action-secondary" (click)="viewReview(notification, $event)">
            <lucide-icon [img]="ExternalLink" [size]="14"></lucide-icon>
            <span>View Full Review</span>
          </button>
        </div>
        
        <!-- Status Badge After Action -->
        <div class="notification-status-badge" *ngIf="hasReply(notification)">
          <lucide-icon [img]="CheckCheck" [size]="12"></lucide-icon>
          <span>Replied</span>
        </div>
      </div>
      
      <div class="notification-actions">
        <button 
          class="btn-action" 
          (click)="markAsRead(notification, $event)"
          *ngIf="!notification.isRead"
          title="Mark as read">
          <lucide-icon [img]="Check" [size]="16"></lucide-icon>
        </button>
        <button 
          class="btn-action delete" 
          (click)="deleteNotification(notification, $event)"
          title="Delete">
          <lucide-icon [img]="Trash2" [size]="16"></lucide-icon>
        </button>
      </div>
      
      <div class="unread-indicator" *ngIf="!notification.isRead"></div>
    </div>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="!loading && filteredNotifications.length === 0">
    <lucide-icon [img]="Bell" [size]="64"></lucide-icon>
    <h3>No Notifications</h3>
    <p *ngIf="filterType !== 'all'">No {{ filterType }} notifications found</p>
    <p *ngIf="filterType === 'all'">You're all caught up!</p>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="loading">
    <div class="spinner"></div>
    <p>Loading notifications...</p>
  </div>

  <!-- Load More -->
  <div class="load-more-section" *ngIf="!loading && hasMore">
    <button class="btn-load-more" (click)="loadMore()" [disabled]="loadingMore">
      {{ loadingMore ? 'Loading...' : 'Load More' }}
    </button>
  </div>
</div>
