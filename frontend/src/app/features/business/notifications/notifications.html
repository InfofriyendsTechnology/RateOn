<div class="notif-page">

  <!-- ── Header Card ───────────────────────────────── -->
  <div class="notif-header">
    <div class="header-left">
      <div class="header-icon">
        <lucide-icon [img]="Bell" [size]="22"></lucide-icon>
      </div>
      <div class="header-text">
        <h1>Notifications</h1>
        <p class="subtitle" *ngIf="unreadCount > 0">
          <span class="unread-pill">{{ unreadCount }}</span>
          unread notification{{ unreadCount > 1 ? 's' : '' }}
        </p>
        <p class="subtitle all-read" *ngIf="unreadCount === 0">
          <span class="check-badge"><lucide-icon [img]="CheckCheck" [size]="11"></lucide-icon></span>
          You're all caught up
        </p>
      </div>
    </div>
    <div class="header-right">
      <div class="header-stats">
        <div class="hstat">
          <span class="hstat-val">{{ notifications.length }}</span>
          <span class="hstat-lbl">Total</span>
        </div>
        <div class="hstat-divider"></div>
        <div class="hstat">
          <span class="hstat-val">{{ todayCount }}</span>
          <span class="hstat-lbl">Today</span>
        </div>
      </div>
      <button class="btn-mark-all" (click)="markAllAsRead()" *ngIf="unreadCount > 0" [disabled]="markingAll">
        <lucide-icon [img]="CheckCheck" [size]="14"></lucide-icon>
        <span>{{ markingAll ? 'Marking...' : 'Mark all read' }}</span>
      </button>
    </div>
  </div>

  <!-- ── Filter Tabs ───────────────────────────────── -->
  <div class="notif-filters">
    <button class="filter-tab" [class.active]="filterType === 'all'" (click)="setFilter('all')">
      <lucide-icon [img]="Bell" [size]="13"></lucide-icon>
      All
      <span class="badge-count" *ngIf="notifications.length > 0">{{ notifications.length }}</span>
    </button>
    <button class="filter-tab" [class.active]="filterType === 'unread'" (click)="setFilter('unread')">
      <lucide-icon [img]="MessageSquare" [size]="13"></lucide-icon>
      Unread
      <span class="badge-hot" *ngIf="unreadCount > 0">{{ unreadCount }}</span>
    </button>
    <button class="filter-tab" [class.active]="filterType === 'follow'" (click)="setFilter('follow')">
      <lucide-icon [img]="UserPlus" [size]="13"></lucide-icon>
      Follows
      <span class="badge-count" *ngIf="getTypeCount('follow') > 0">{{ getTypeCount('follow') }}</span>
    </button>
    <button class="filter-tab" [class.active]="filterType === 'review'" (click)="setFilter('review')">
      <lucide-icon [img]="Star" [size]="13"></lucide-icon>
      Reviews
      <span class="badge-count" *ngIf="getTypeCount('review') > 0">{{ getTypeCount('review') }}</span>
    </button>
    <button class="filter-tab" [class.active]="filterType === 'reply'" (click)="setFilter('reply')">
      <lucide-icon [img]="Reply" [size]="13"></lucide-icon>
      Replies
      <span class="badge-count" *ngIf="getTypeCount('reply') > 0">{{ getTypeCount('reply') }}</span>
    </button>
    <button class="filter-tab" [class.active]="filterType === 'reaction'" (click)="setFilter('reaction')">
      <lucide-icon [img]="ThumbsUp" [size]="13"></lucide-icon>
      Reactions
      <span class="badge-count" *ngIf="getTypeCount('reaction') > 0">{{ getTypeCount('reaction') }}</span>
    </button>
  </div>

  <!-- ── Skeleton Loader ───────────────────────────── -->
  <div class="notif-card" *ngIf="loading">
    <div class="skeleton-item" *ngFor="let i of [1,2,3,4,5]">
      <div class="skel skel-avatar"></div>
      <div class="skel-body">
        <div class="skel skel-line long"></div>
        <div class="skel skel-line short"></div>
      </div>
    </div>
  </div>

  <!-- ── Empty State ───────────────────────────────── -->
  <div class="notif-empty" *ngIf="!loading && filteredNotifications.length === 0">
    <div class="empty-icon-wrap">
      <lucide-icon [img]="Bell" [size]="30"></lucide-icon>
    </div>
    <h3>{{ filterType === 'unread' ? "You're all caught up!" : 'No Notifications Yet' }}</h3>
    <p>{{ filterType !== 'all' ? 'No ' + filterType + ' notifications found' : 'New reviews and interactions will appear here' }}</p>
  </div>

  <!-- ── Notification List ─────────────────────────── -->
  <div class="notif-card" *ngIf="!loading && filteredNotifications.length > 0">
    <div
      class="notif-item"
      *ngFor="let notification of filteredNotifications"
      [class.is-unread]="!notification.isRead"
      (click)="handleNotificationClick(notification)">

      <!-- left accent bar -->
      <span class="accent-bar" [class]="getNotificationIconClass(notification.type)"></span>

      <!-- avatar -->
      <div class="n-avatar">
        <img
          *ngIf="getUserAvatar(notification) && !avatarFailed[notification._id]"
          [src]="getUserAvatar(notification)"
          [alt]="getUserName(notification)"
          crossorigin="anonymous"
          referrerpolicy="no-referrer"
          (error)="onAvatarError(notification._id)" />
        <span *ngIf="!getUserAvatar(notification) || avatarFailed[notification._id]" class="n-initial">
          {{ getUserName(notification).charAt(0).toUpperCase() || 'U' }}
        </span>
        <span class="n-type-badge" [class]="getNotificationIconClass(notification.type)">
          <lucide-icon [img]="getNotificationIcon(notification.type)" [size]="10"></lucide-icon>
        </span>
      </div>

      <!-- content -->
      <div class="n-content">

        <!-- Primary message -->
        <p class="n-message">
          <strong>{{ getUserName(notification) }}</strong>
          {{ getActionText(notification.type) }}
        </p>

        <!-- Detail message -->
        <p class="n-detail" *ngIf="notification.message">{{ notification.message }}</p>

        <!-- Meta row -->
        <div class="n-meta">
          <span class="n-chip">{{ getNotificationIconClass(notification.type) }}</span>
          <span class="n-dot-sep">·</span>
          <span class="n-time">{{ getTimeAgo(notification.createdAt) }}</span>
          <ng-container *ngIf="notification.metadata?.businessName">
            <span class="n-dot-sep">·</span>
            <span class="n-biz">
              <lucide-icon [img]="ShoppingBag" [size]="11"></lucide-icon>
              {{ notification.metadata.businessName }}
            </span>
          </ng-container>
        </div>

        <!-- Rating Stars -->
        <div class="n-rating" *ngIf="notification.metadata?.rating">
          <span
            *ngFor="let i of [1,2,3,4,5]"
            class="star"
            [class.filled]="i <= notification.metadata.rating"
            [class.empty]="i > notification.metadata.rating">★</span>
        </div>

        <!-- Reaction Buttons -->
        <div class="n-reactions" *ngIf="isReviewNotification(notification) && hasReviewId(notification)" (click)="$event.stopPropagation()">
          <app-reaction-buttons
            [reviewId]="notification.metadata.reviewId"
            [reviewOwnerId]="getReviewOwnerId(notification)"
            [initialStats]="getReactionStats(notification)"
            [userReaction]="getUserReaction(notification)"
            [compact]="true"
            (reactionChanged)="onReactionChanged(notification, $event)">
          </app-reaction-buttons>
        </div>

        <!-- Reply display -->
        <div class="n-reply-display" *ngIf="hasReply(notification)">
          <div class="reply-label">
            <lucide-icon [img]="MessageSquare" [size]="12"></lucide-icon>
            <span>Latest Reply</span>
          </div>
          <p class="reply-text">{{ notification.metadata.replies[0].comment || notification.metadata.replies[0].text }}</p>
          <span class="reply-time">{{ getTimeAgo(notification.metadata.replies[0].createdAt) }}</span>
        </div>

        <!-- Reply Form -->
        <div class="n-reply-form" *ngIf="isReviewNotification(notification) && replyingToNotification === notification._id" (click)="$event.stopPropagation()">
          <textarea
            class="reply-input"
            [(ngModel)]="replyText[notification._id]"
            placeholder="Write your reply as business owner..."
            rows="3"
            [disabled]="submittingReply"
            (click)="$event.stopPropagation()">
          </textarea>
          <div class="reply-form-actions">
            <button class="btn-cancel" (click)="cancelReply(notification._id, $event)" [disabled]="submittingReply">Cancel</button>
            <button class="btn-submit-reply" (click)="submitReply(notification, $event)" [disabled]="submittingReply || !replyText[notification._id]?.trim()">
              {{ submittingReply ? 'Sending...' : 'Send Reply' }}
            </button>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="n-action-btns" *ngIf="isReviewNotification(notification)" (click)="$event.stopPropagation()">
          <button class="btn-reply"
            *ngIf="!hasReply(notification) && replyingToNotification !== notification._id"
            (click)="startReply(notification._id, $event)">
            <lucide-icon [img]="Reply" [size]="13"></lucide-icon>
            Reply
          </button>
          <button class="btn-view" (click)="viewReview(notification, $event)">
            <lucide-icon [img]="ExternalLink" [size]="13"></lucide-icon>
            View Review
          </button>
          <span class="n-replied-badge" *ngIf="hasReply(notification)">
            <lucide-icon [img]="CheckCheck" [size]="12"></lucide-icon>
            Replied
          </span>
        </div>

      </div>

      <!-- right: unread dot + quick actions -->
      <div class="n-right">
        <div class="unread-dot" *ngIf="!notification.isRead"></div>
        <div class="n-actions" (click)="$event.stopPropagation()">
          <button class="n-btn n-read" *ngIf="!notification.isRead" (click)="markAsRead(notification, $event)" title="Mark as read">
            <lucide-icon [img]="Check" [size]="13"></lucide-icon>
          </button>
          <button class="n-btn n-del" (click)="deleteNotification(notification, $event)" title="Delete">
            <lucide-icon [img]="Trash2" [size]="13"></lucide-icon>
          </button>
        </div>
      </div>

    </div>
  </div>

  <!-- ── Load More ─────────────────────────────────── -->
  <div class="load-more-wrap" *ngIf="!loading && hasMore">
    <button class="load-more-btn" (click)="loadMore()" [disabled]="loadingMore">
      <lucide-icon [img]="Bell" [size]="14"></lucide-icon>
      {{ loadingMore ? 'Loading...' : 'Load more' }}
    </button>
  </div>

</div>
