<div class="dashboard-layout">
  <!-- Mobile Backdrop -->
  <div class="mobile-backdrop" [class.show]="sidebarOpen" (click)="toggleSidebar()"></div>
  
  <!-- Sidebar -->
  <aside class="sidebar" [class.mobile-open]="sidebarOpen">
    <div class="sidebar-header">
      <div class="logo">
        <!-- Full logo when sidebar is open -->
        <img *ngIf="sidebarOpen && isDarkMode" src="/LOGO_WHITE.png" alt="RateOn" class="logo-full">
        <img *ngIf="sidebarOpen && !isDarkMode" src="/LOGO_BLACK.png" alt="RateOn" class="logo-full">
        
        <!-- Icon logo when sidebar is collapsed -->
        <img *ngIf="!sidebarOpen && isDarkMode" src="/LOGO_WHITE_ICON.png" alt="RateOn" class="logo-small">
        <img *ngIf="!sidebarOpen && !isDarkMode" src="/LOGO_BLACK_ICON.png" alt="RateOn" class="logo-small">
      </div>
      
      <!-- Mobile Close Button -->
      <button *ngIf="sidebarOpen" class="sidebar-close-btn" (click)="toggleSidebar()" aria-label="Close sidebar">
        <lucide-icon [img]="X" [size]="20"></lucide-icon>
      </button>
    </div>

    <nav class="sidebar-nav">
      <a routerLink="/owner" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}" class="nav-item" (click)="closeSidebarOnMobile()">
        <lucide-icon [img]="LayoutDashboard" [size]="16" class="nav-icon"></lucide-icon>
        <span class="nav-text" *ngIf="sidebarOpen">Dashboard</span>
      </a>
      
      <a routerLink="/owner/businesses" routerLinkActive="active" class="nav-item" (click)="closeSidebarOnMobile()">
        <lucide-icon [img]="ShoppingBag" [size]="16" class="nav-icon"></lucide-icon>
        <span class="nav-text" *ngIf="sidebarOpen">Businesses</span>
      </a>
      
      <a routerLink="/owner/reviews" routerLinkActive="active" class="nav-item" (click)="closeSidebarOnMobile()">
        <lucide-icon [img]="MessageSquare" [size]="16" class="nav-icon"></lucide-icon>
        <span class="nav-text" *ngIf="sidebarOpen">Reviews</span>
        <span class="nav-badge" *ngIf="sidebarOpen && unreadNotificationsCount > 0">{{ unreadNotificationsCount }}</span>
      </a>
      
      <div class="nav-divider" *ngIf="sidebarOpen"></div>
      <span class="nav-section-label" *ngIf="sidebarOpen">SETTINGS</span>
      
      <a routerLink="/owner/settings" routerLinkActive="active" class="nav-item" (click)="closeSidebarOnMobile()">
        <lucide-icon [img]="Settings" [size]="16" class="nav-icon"></lucide-icon>
        <span class="nav-text" *ngIf="sidebarOpen">Settings</span>
      </a>
      
      <div class="nav-divider" *ngIf="sidebarOpen"></div>
      <span class="nav-section-label" *ngIf="sidebarOpen">ACCOUNT</span>
      
      <a routerLink="/owner/profile" routerLinkActive="active" class="nav-item" (click)="closeSidebarOnMobile()">
        <lucide-icon [img]="User" [size]="16" class="nav-icon"></lucide-icon>
        <span class="nav-text" *ngIf="sidebarOpen">Profile</span>
      </a>
    </nav>

    <div class="sidebar-footer">
      <!-- User Profile -->
      <div class="user-profile">
        <div class="user-avatar">
          <img *ngIf="getUserAvatar() && !avatarFailed" [src]="getUserAvatar()" [alt]="user?.username" 
               class="avatar-image" crossorigin="anonymous" referrerpolicy="no-referrer"
               (error)="onAvatarError($event)">
          <span *ngIf="!getUserAvatar() || avatarFailed" class="avatar-initial">{{ user?.username?.charAt(0).toUpperCase() }}</span>
        </div>
        <div class="user-info" *ngIf="sidebarOpen">
          <div class="user-name">{{ user?.username }}</div>
          <div class="user-role">Business Owner</div>
        </div>
      </div>
      
      <!-- Logout Button -->
      <button class="logout-btn" (click)="logout()">
        <lucide-icon [img]="LogOut" [size]="16"></lucide-icon>
        <span *ngIf="sidebarOpen">Logout</span>
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="top-bar-left">
        <button class="sidebar-toggle mobile-only" (click)="toggleSidebar(); $event.stopPropagation()">
          <lucide-icon [img]="Menu" [size]="20"></lucide-icon>
        </button>
        <button class="notification-bell" [routerLink]="['/owner/notifications']" title="View notifications">
          <lucide-icon [img]="Bell" [size]="20"></lucide-icon>
          <span class="notification-badge" *ngIf="unreadNotificationsCount > 0">{{ unreadNotificationsCount }}</span>
        </button>
      </div>
      <div class="page-title">
        <h1>{{ getPageTitle() }}</h1>
      </div>
      <div class="top-bar-right">
        <button *ngIf="isOnItemsPage()" class="btn-add-business" (click)="openAddItem()">
          <lucide-icon [img]="Plus" [size]="18"></lucide-icon>
          <span>Add Item</span>
        </button>
        <a *ngIf="isOnBusinessesPage() && !isOnItemsPage()" class="btn-add-business" routerLink="/owner/businesses/new">
          <lucide-icon [img]="Plus" [size]="18"></lucide-icon>
          <span>Add Business</span>
        </a>
      </div>
    </div>

    <!-- Dashboard Content -->
    <div class="content-wrapper">
      <router-outlet></router-outlet>
      <div class="dashboard-content" *ngIf="!isChildRouteActive()">
        
        <!-- Welcome Greeting -->
        <div class="welcome-greeting">
          <h2>{{ greeting }}, {{ user?.username || user?.firstName || 'User' }}! ðŸ‘‹</h2>
          <p>Welcome to your business dashboard</p>
        </div>
      
        <!-- Statistics Cards -->
      <div class="stats-grid" *ngIf="businesses.length > 0">
        <div class="stat-card">
          <div class="stat-icon businesses">
            <lucide-icon [img]="ShoppingBag" [size]="24"></lucide-icon>
          </div>
          <div class="stat-content">
            <h3 class="stat-value">{{ businesses.length }}</h3>
            <p class="stat-label">Total Businesses</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon items">
            <lucide-icon [img]="ShoppingBag" [size]="24"></lucide-icon>
          </div>
          <div class="stat-content">
            <h3 class="stat-value">{{ totalItems }}</h3>
            <p class="stat-label">Total Items</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon reviews">
            <lucide-icon [img]="Star" [size]="24"></lucide-icon>
          </div>
          <div class="stat-content">
            <h3 class="stat-value">{{ totalReviews }}</h3>
            <p class="stat-label">Total Reviews</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon rating">
            <lucide-icon [img]="Star" [size]="24"></lucide-icon>
          </div>
          <div class="stat-content">
            <h3 class="stat-value">{{ averageRating.toFixed(1) }}</h3>
            <p class="stat-label">Avg Rating</p>
          </div>
        </div>
      </div>

      <!-- No Business State -->
      <div class="empty-state" *ngIf="businesses.length === 0 && !loadingBusinesses">
        <lucide-icon [img]="ShoppingBag" [size]="64" class="empty-icon"></lucide-icon>
        <h3>No Businesses Yet</h3>
        <p>Get started by creating your first business.</p>
        <a routerLink="/owner/businesses/new" class="btn-primary">
          <lucide-icon [img]="Plus" [size]="16"></lucide-icon>
          Create Business
        </a>
      </div>

      <!-- Loading State -->
      <div class="loading-state" *ngIf="loadingBusinesses">
        <div class="spinner"></div>
        <p>Loading businesses...</p>
      </div>

      </div>
    </div>
  </main>
</div>

<!-- Business Creation Modal -->
<div *ngIf="showBusinessModal" class="modal-overlay" (click)="closeBusinessModal()">
  <div class="modal-content business-modal" (click)="$event.stopPropagation()">
    <button *ngIf="currentBusinessStep > 1" class="btn-back-modal" (click)="previousBusinessStep()" aria-label="Back">
      <lucide-icon [img]="ArrowLeft" [size]="20"></lucide-icon>
    </button>
    
    <button class="btn-close-modal" (click)="closeBusinessModal()" aria-label="Close">
      <lucide-icon [img]="X" [size]="20"></lucide-icon>
    </button>
    
    <div class="modal-header">
      <h3>Create Business</h3>
      <p>Step {{ currentBusinessStep }} of {{ totalBusinessSteps }}</p>
    </div>
    
    <div class="modal-body business-form">
      <!-- Step 1: Business Name & Type -->
      <div *ngIf="currentBusinessStep === 1">
        <div class="form-group">
          <label>Business Name <span class="required">*</span></label>
          <input 
            type="text" 
            [(ngModel)]="businessForm.name" 
            placeholder="Enter business name"
            class="form-input"
            autofocus
          />
        </div>
        
        <div class="form-group">
          <label>Business Type <span class="required">*</span></label>
          <select [(ngModel)]="businessForm.type" class="form-input" (change)="onBusinessTypeChange()">
            <option value="">Select type</option>
            <option value="restaurant">Restaurant</option>
            <option value="cafe">CafÃ©</option>
            <option value="shop">Shop</option>
            <option value="service">Service</option>
            <option value="other">Other</option>
          </select>
        </div>
        
        <!-- Custom Type Input (shown when Other is selected) -->
        <div class="form-group" *ngIf="businessForm.type === 'other'">
          <label>Specify Business Type <span class="required">*</span></label>
          <input 
            type="text" 
            [(ngModel)]="businessForm.customType" 
            placeholder="e.g., Bakery, Salon, Gym"
            class="form-input"
          />
        </div>
      </div>
      
      <!-- Step 2: Location -->
      <div *ngIf="currentBusinessStep === 2">
        <div class="form-group">
          <label>Address <span class="required">*</span></label>
          <input 
            type="text" 
            [(ngModel)]="businessForm.address" 
            placeholder="Street address"
            class="form-input"
            autofocus
          />
        </div>
        
        <div class="form-group">
          <label>City <span class="required">*</span></label>
          <input 
            type="text" 
            [(ngModel)]="businessForm.city" 
            placeholder="City name"
            class="form-input"
          />
        </div>
        
        <div class="form-group">
          <label>State <span class="required">*</span></label>
          <input 
            type="text" 
            [(ngModel)]="businessForm.state" 
            placeholder="State/Province"
            class="form-input"
          />
        </div>
      </div>
      
      <!-- Step 3: Contact & Description -->
      <div *ngIf="currentBusinessStep === 3">
        <div class="form-group">
          <label>Phone</label>
          <input 
            type="tel" 
            [(ngModel)]="businessForm.phone" 
            placeholder="+1 234 567 8900"
            class="form-input"
            autofocus
          />
        </div>
        
        <div class="form-group">
          <label>Website</label>
          <input 
            type="url" 
            [(ngModel)]="businessForm.website" 
            placeholder="https://example.com"
            class="form-input"
          />
        </div>
        
        <div class="form-group">
          <label>Description</label>
          <textarea 
            [(ngModel)]="businessForm.description" 
            placeholder="Brief description (optional)"
            rows="3"
            class="form-input"
          ></textarea>
        </div>
      </div>
    </div>
    
    <div class="modal-actions">
      <div class="btn-group" *ngIf="currentBusinessStep === 1">
        <button class="btn-modal-primary" (click)="nextBusinessStep()">
          Continue
        </button>
      </div>
      
      <div class="btn-group" *ngIf="currentBusinessStep === 2">
        <button class="btn-modal-primary" (click)="nextBusinessStep()">
          Continue
        </button>
      </div>
      
      <div class="btn-group" *ngIf="currentBusinessStep === 3">
        <button class="btn-modal-primary" (click)="addBusiness()" [disabled]="addingBusiness">
          {{ addingBusiness ? 'Creating...' : 'Create Business' }}
        </button>
      </div>
    </div>
  </div>
</div>
