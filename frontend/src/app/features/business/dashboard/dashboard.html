<div class="dashboard-layout">
  <!-- Mobile Backdrop -->
  <div class="mobile-backdrop" [class.show]="sidebarOpen" (click)="toggleSidebar()"></div>
  
  <!-- Sidebar -->
  <aside class="sidebar" [class.mobile-open]="sidebarOpen">
    <div class="sidebar-header">
      <div class="logo">
        <!-- Full logo when sidebar is open -->
        <img *ngIf="sidebarOpen && isDarkMode" src="/LOGO_WHITE.png" alt="RateOn" class="logo-full">
        <img *ngIf="sidebarOpen && !isDarkMode" src="/LOGO_BLACK.png" alt="RateOn" class="logo-full">
        
        <!-- Icon logo when sidebar is collapsed -->
        <img *ngIf="!sidebarOpen && isDarkMode" src="/LOGO_WHITE_ICON.png" alt="RateOn" class="logo-small">
        <img *ngIf="!sidebarOpen && !isDarkMode" src="/LOGO_BLACK_ICON.png" alt="RateOn" class="logo-small">
      </div>
      
      <!-- Mobile Close Button -->
      <button *ngIf="sidebarOpen" class="sidebar-close-btn" (click)="toggleSidebar()" aria-label="Close sidebar">
        <lucide-icon [img]="X" [size]="20"></lucide-icon>
      </button>
    </div>

    <nav class="sidebar-nav">
      <a routerLink="/owner" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}" class="nav-item" (click)="closeSidebarOnMobile()">
        <lucide-icon [img]="LayoutDashboard" [size]="16" class="nav-icon"></lucide-icon>
        <span class="nav-text" *ngIf="sidebarOpen">Dashboard</span>
      </a>
      
      <a routerLink="/owner/businesses" routerLinkActive="active" class="nav-item" (click)="closeSidebarOnMobile()">
        <lucide-icon [img]="ShoppingBag" [size]="16" class="nav-icon"></lucide-icon>
        <span class="nav-text" *ngIf="sidebarOpen">Businesses</span>
      </a>

      <a routerLink="/search" routerLinkActive="active" class="nav-item" (click)="closeSidebarOnMobile()">
        <lucide-icon [img]="Compass" [size]="16" class="nav-icon"></lucide-icon>
        <span class="nav-text" *ngIf="sidebarOpen">Explore</span>
      </a>
      
      <a routerLink="/owner/reviews" routerLinkActive="active" class="nav-item" (click)="closeSidebarOnMobile()">
        <lucide-icon [img]="MessageSquare" [size]="16" class="nav-icon"></lucide-icon>
        <span class="nav-text" *ngIf="sidebarOpen">Reviews</span>
        <span class="nav-badge" *ngIf="sidebarOpen && unreadNotificationsCount > 0">{{ unreadNotificationsCount }}</span>
      </a>

      <a routerLink="/owner/analytics" routerLinkActive="active" class="nav-item" (click)="closeSidebarOnMobile()">
        <lucide-icon [img]="BarChart2" [size]="16" class="nav-icon"></lucide-icon>
        <span class="nav-text" *ngIf="sidebarOpen">Analytics</span>
      </a>
      
      <div class="nav-divider" *ngIf="sidebarOpen"></div>
      <span class="nav-section-label" *ngIf="sidebarOpen">SETTINGS</span>
      
      <a routerLink="/owner/settings" routerLinkActive="active" class="nav-item" (click)="closeSidebarOnMobile()">
        <lucide-icon [img]="Settings" [size]="16" class="nav-icon"></lucide-icon>
        <span class="nav-text" *ngIf="sidebarOpen">Settings</span>
      </a>
      
      <div class="nav-divider" *ngIf="sidebarOpen"></div>
      <span class="nav-section-label" *ngIf="sidebarOpen">ACCOUNT</span>
      
      <a routerLink="/owner/profile" routerLinkActive="active" class="nav-item" (click)="closeSidebarOnMobile()">
        <lucide-icon [img]="User" [size]="16" class="nav-icon"></lucide-icon>
        <span class="nav-text" *ngIf="sidebarOpen">Profile</span>
      </a>
    </nav>

    <div class="sidebar-footer">
      <!-- User Profile -->
      <div class="user-profile">
        <div class="user-avatar">
          <img *ngIf="getUserAvatar() && !avatarFailed" [src]="getUserAvatar()" [alt]="user?.username" 
               class="avatar-image" crossorigin="anonymous" referrerpolicy="no-referrer"
               (error)="onAvatarError($event)">
          <span *ngIf="!getUserAvatar() || avatarFailed" class="avatar-initial">{{ user?.username?.charAt(0).toUpperCase() }}</span>
        </div>
        <div class="user-info" *ngIf="sidebarOpen">
          <div class="user-name">{{ user?.username }}</div>
          <div class="user-role">Business Owner</div>
        </div>
      </div>
      
      <!-- Logout Button -->
      <button class="logout-btn" (click)="logout()">
        <lucide-icon [img]="LogOut" [size]="16"></lucide-icon>
        <span *ngIf="sidebarOpen">Logout</span>
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="top-bar-left">
        <button class="sidebar-toggle mobile-only" (click)="toggleSidebar(); $event.stopPropagation()">
          <lucide-icon [img]="Menu" [size]="20"></lucide-icon>
        </button>
        <app-breadcrumbs class="top-crumbs" [crumbs]="topBarCrumbs"></app-breadcrumbs>
      </div>
      <div class="top-bar-right">
        <button class="notification-bell" [routerLink]="['/owner/notifications']" title="View notifications">
          <lucide-icon [img]="Bell" [size]="20"></lucide-icon>
          <span class="notification-badge" *ngIf="unreadNotificationsCount > 0">{{ unreadNotificationsCount }}</span>
        </button>
      </div>
    </div>

    <!-- Dashboard Content -->
    <div class="content-wrapper">
      <router-outlet></router-outlet>

      <!-- Home dashboard (only shown when no child route is active) -->
      <div class="owner-dashboard" *ngIf="!isChildRouteActive()">

        <!-- ── Header Card ── -->
        <div class="dash-header">
          <div class="header-left">
            <div class="header-icon">
              <lucide-icon [img]="LayoutDashboard" [size]="22"></lucide-icon>
            </div>
            <div class="header-text">
              <h1>{{ greeting }}, {{ user?.profile?.firstName || user?.username || 'Owner' }}!</h1>
              <p class="subtitle">{{ todayDate }}</p>
            </div>
          </div>
        </div>

        <!-- ── Loading ── -->
        <div *ngIf="loadingBusinesses" class="loading-container">
          <div class="spinner"></div>
          <p>Loading...</p>
        </div>

        <ng-container *ngIf="!loadingBusinesses">

          <!-- ── Stat Cards ── -->
          <div class="stat-cards" *ngIf="businesses.length > 0">
            <div class="stat-card">
              <div class="stat-icon c-yellow"><lucide-icon [img]="ShoppingBag" [size]="24"></lucide-icon></div>
              <div class="stat-body">
                <div class="stat-val">{{ businesses.length }}</div>
                <div class="stat-lbl">Businesses</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon c-blue"><lucide-icon [img]="Package" [size]="24"></lucide-icon></div>
              <div class="stat-body">
                <div class="stat-val">{{ totalItems }}</div>
                <div class="stat-lbl">Total Items</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon c-green"><lucide-icon [img]="MessageSquare" [size]="24"></lucide-icon></div>
              <div class="stat-body">
                <div class="stat-val">{{ totalReviews }}</div>
                <div class="stat-lbl">Total Reviews</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon c-orange"><lucide-icon [img]="Star" [size]="24"></lucide-icon></div>
              <div class="stat-body">
                <div class="stat-val">{{ averageRating.toFixed(1) }}</div>
                <div class="stat-lbl">Avg Rating</div>
              </div>
            </div>
          </div>


          <!-- ── Recent Businesses ── -->
          <div class="section-card" *ngIf="businesses.length > 0">
            <div class="section-header">
              <h3>My Businesses</h3>
              <a routerLink="/owner/businesses" class="btn-view-all">View All</a>
            </div>
            <div class="biz-list">
              <a class="biz-row" *ngFor="let b of businesses.slice(0, 3)" [routerLink]="['/owner/businesses', b._id]">
                <div class="biz-icon">
                  <img *ngIf="b.logo" [src]="b.logo" [alt]="b.name" class="biz-logo" />
                  <lucide-icon *ngIf="!b.logo" [img]="ShoppingBag" [size]="18"></lucide-icon>
                </div>
                <div class="biz-info">
                  <span class="biz-name">{{ b.name }}</span>
                  <span class="biz-type">{{ b.category || b.type }}</span>
                </div>
                <div class="biz-stats">
                  <span class="biz-stat"><lucide-icon [img]="MessageSquare" [size]="12"></lucide-icon> {{ b.stats?.totalReviews || b.reviewCount || 0 }}</span>
                  <span class="biz-stat"><lucide-icon [img]="Star" [size]="12"></lucide-icon> {{ (b.averageRating || b.rating || 0).toFixed(1) }}</span>
                </div>
              </a>
            </div>
          </div>

          <!-- ── No Business Empty State ── -->
          <div class="section-card empty-biz-card" *ngIf="businesses.length === 0">
            <div class="empty-biz">
              <div class="empty-icon-wrap">
                <lucide-icon [img]="ShoppingBag" [size]="32"></lucide-icon>
              </div>
              <h3>No Businesses Yet</h3>
              <p>Get started by creating your first business.</p>
              <a routerLink="/owner/businesses/new" class="btn-create">
                <lucide-icon [img]="Plus" [size]="16"></lucide-icon>
                Create Business
              </a>
            </div>
          </div>

        </ng-container>
      </div>
    </div>
  </main>
</div>

<!-- Business Creation Modal -->
<div *ngIf="showBusinessModal" class="modal-overlay" (click)="closeBusinessModal()">
  <div class="modal-content business-modal" (click)="$event.stopPropagation()">
    <button *ngIf="currentBusinessStep > 1" class="btn-back-modal" (click)="previousBusinessStep()" aria-label="Back">
      <lucide-icon [img]="ArrowLeft" [size]="20"></lucide-icon>
    </button>
    
    <button class="btn-close-modal" (click)="closeBusinessModal()" aria-label="Close">
      <lucide-icon [img]="X" [size]="20"></lucide-icon>
    </button>
    
    <div class="modal-header">
      <h3>Create Business</h3>
      <p>Step {{ currentBusinessStep }} of {{ totalBusinessSteps }}</p>
    </div>
    
    <div class="modal-body business-form">
      <!-- Step 1: Business Name & Type -->
      <div *ngIf="currentBusinessStep === 1">
        <div class="form-group">
          <label>Business Name <span class="required">*</span></label>
          <input 
            type="text" 
            [(ngModel)]="businessForm.name" 
            placeholder="Enter business name"
            class="form-input"
            autofocus
          />
        </div>
        
        <div class="form-group">
          <label>Business Type <span class="required">*</span></label>
          <select [(ngModel)]="businessForm.type" class="form-input" (change)="onBusinessTypeChange()">
            <option value="">Select type</option>
            <option value="restaurant">Restaurant</option>
            <option value="cafe">Café</option>
            <option value="shop">Shop</option>
            <option value="service">Service</option>
            <option value="other">Other</option>
          </select>
        </div>
        
        <!-- Custom Type Input (shown when Other is selected) -->
        <div class="form-group" *ngIf="businessForm.type === 'other'">
          <label>Specify Business Type <span class="required">*</span></label>
          <input 
            type="text" 
            [(ngModel)]="businessForm.customType" 
            placeholder="e.g., Bakery, Salon, Gym"
            class="form-input"
          />
        </div>
      </div>
      
      <!-- Step 2: Location -->
      <div *ngIf="currentBusinessStep === 2">
        <div class="form-group">
          <label>Address <span class="required">*</span></label>
          <input 
            type="text" 
            [(ngModel)]="businessForm.address" 
            placeholder="Street address"
            class="form-input"
            autofocus
          />
        </div>
        
        <div class="form-group">
          <label>City <span class="required">*</span></label>
          <input 
            type="text" 
            [(ngModel)]="businessForm.city" 
            placeholder="City name"
            class="form-input"
          />
        </div>
        
        <div class="form-group">
          <label>State <span class="required">*</span></label>
          <input 
            type="text" 
            [(ngModel)]="businessForm.state" 
            placeholder="State/Province"
            class="form-input"
          />
        </div>
      </div>
      
      <!-- Step 3: Contact & Description -->
      <div *ngIf="currentBusinessStep === 3">
        <div class="form-group">
          <label>Phone</label>
          <input 
            type="tel" 
            [(ngModel)]="businessForm.phone" 
            placeholder="+1 234 567 8900"
            class="form-input"
            autofocus
          />
        </div>
        
        <div class="form-group">
          <label>Website</label>
          <input 
            type="url" 
            [(ngModel)]="businessForm.website" 
            placeholder="https://example.com"
            class="form-input"
          />
        </div>
        
        <div class="form-group">
          <label>Description</label>
          <textarea 
            [(ngModel)]="businessForm.description" 
            placeholder="Brief description (optional)"
            rows="3"
            class="form-input"
          ></textarea>
        </div>
      </div>
    </div>
    
    <div class="modal-actions">
      <div class="btn-group" *ngIf="currentBusinessStep === 1">
        <button class="btn-modal-primary" (click)="nextBusinessStep()">
          Continue
        </button>
      </div>
      
      <div class="btn-group" *ngIf="currentBusinessStep === 2">
        <button class="btn-modal-primary" (click)="nextBusinessStep()">
          Continue
        </button>
      </div>
      
      <div class="btn-group" *ngIf="currentBusinessStep === 3">
        <button class="btn-modal-primary" (click)="addBusiness()" [disabled]="addingBusiness">
          {{ addingBusiness ? 'Creating...' : 'Create Business' }}
        </button>
      </div>
    </div>
  </div>
</div>
