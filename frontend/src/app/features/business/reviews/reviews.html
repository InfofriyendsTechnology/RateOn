<div class="reviews-management-container">
  <!-- Header with Stats -->
  <div class="reviews-header">
    <div class="header-content">
      <h1>Review Management</h1>
      <p>Manage and respond to reviews across all your businesses</p>
    </div>
    
    <div class="stats-summary">
      <div class="stat-item">
        <span class="stat-value">{{ reviews.length }}</span>
        <span class="stat-label">Total Reviews</span>
      </div>
      <div class="stat-item pending">
        <span class="stat-value">{{ getPendingRepliesCount() }}</span>
        <span class="stat-label">Pending Reply</span>
      </div>
      <div class="stat-item replied">
        <span class="stat-value">{{ getRepliedCount() }}</span>
        <span class="stat-label">Replied</span>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-bar">
    <div class="filter-group">
      <lucide-icon [img]="Filter" [size]="18"></lucide-icon>
      <select class="filter-select" [(ngModel)]="selectedBusiness" (change)="onBusinessFilterChange()">
        <option value="all">All Businesses</option>
        <option *ngFor="let business of businesses" [value]="business._id">{{ business.name }}</option>
      </select>
    </div>
    
    <div class="filter-group">
      <select class="filter-select" [(ngModel)]="selectedStatus" (change)="onStatusFilterChange()">
        <option value="all">All Status</option>
        <option value="pending">Pending Reply</option>
        <option value="replied">Replied</option>
      </select>
    </div>
    
    <div class="search-box">
      <lucide-icon [img]="Search" [size]="18"></lucide-icon>
      <input 
        type="text" 
        placeholder="Search reviews..." 
        [(ngModel)]="searchQuery"
        (input)="onSearchChange()"
        class="search-input"
      />
    </div>
  </div>

  <!-- Reviews List -->
  <div class="reviews-list" *ngIf="!loadingReviews && filteredReviews.length > 0">
    <div class="review-card" *ngFor="let review of filteredReviews" [id]="'review-' + review._id">
      <!-- Review Header -->
      <div class="review-header">
        <div class="reviewer-info">
          <div class="reviewer-avatar">
            <img *ngIf="getAvatarUrl(review) && !avatarFailed[review._id]" 
                 [src]="getAvatarUrl(review)" 
                 [alt]="getUserDisplayName(review)"
                 class="avatar-image"
                 crossorigin="anonymous"
                 referrerpolicy="no-referrer"
                 (error)="onAvatarError(review._id)" />
            <span *ngIf="!getAvatarUrl(review) || avatarFailed[review._id]" class="avatar-initial">
              {{ getUserDisplayName(review).charAt(0).toUpperCase() }}
            </span>
          </div>
          <div class="reviewer-details">
            <h4 class="reviewer-name">{{ review.userId?.name || review.userId?.firstName || review.userId?.username || 'Anonymous User' }}</h4>
            <div class="review-meta">
              <div class="rating-stars">
                <span *ngFor="let i of [1,2,3,4,5]" 
                  class="star"
                  [class.filled]="i <= review.rating"
                  [class.empty]="i > review.rating">
                  â˜…
                </span>
              </div>
              <span class="review-date">{{ getTimeAgo(review.createdAt) }}</span>
            </div>
          </div>
        </div>
        
        <div class="review-header-actions">
          <!-- Business Badge -->
          <div class="business-badge-inline">
            <lucide-icon [img]="ShoppingBag" [size]="12"></lucide-icon>
            <span>{{ review.businessInfo?.name }}</span>
          </div>
          <button class="btn-view" (click)="viewReview(review)" title="View on public page">
            <lucide-icon [img]="ExternalLink" [size]="14"></lucide-icon>
            <span>View</span>
          </button>
        </div>
      </div>
      
      <!-- Review Content -->
      <div class="review-content">
        <p>{{ review.reviewText || review.comment }}</p>
      </div>
      
      <!-- Review Images -->
      <div class="review-images" *ngIf="review.images?.length > 0">
        <img *ngFor="let img of review.images.slice(0, 3)" 
             [src]="img" 
             [alt]="'Review photo'" 
             class="review-image" />
      </div>
      
      <!-- Reactions - Interactive Buttons -->
      <div class="review-reactions">
        <app-reaction-buttons
          [reviewId]="review._id"
          [reviewOwnerId]="getReviewOwnerId(review)"
          [initialStats]="{
            helpful: review.reactions?.helpful || 0,
            notHelpful: review.reactions?.notHelpful || 0,
            total: (review.reactions?.helpful || 0) + (review.reactions?.notHelpful || 0)
          }"
          [compact]="true"
          (reactionChanged)="onReactionChanged(review, $event)">
        </app-reaction-buttons>
      </div>
      
      <!-- Reply Section -->
      <div class="reply-section" *ngIf="review.replies && review.replies.length > 0">
        <div class="reply-indicator">
          <lucide-icon [img]="MessageSquare" [size]="16"></lucide-icon>
          <span>Your Reply</span>
        </div>
        <div class="reply-content">
          <p>{{ review.replies[0].comment || review.replies[0].text }}</p>
          <span class="reply-time">{{ getTimeAgo(review.replies[0].createdAt) }}</span>
        </div>
      </div>
      
      <!-- Reply Form -->
      <div class="reply-form" *ngIf="replyingToReview === review._id">
        <textarea 
          class="reply-input" 
          [(ngModel)]="replyText[review._id]" 
          placeholder="Write your reply as business owner..."
          rows="3"
          [disabled]="submittingReply">
        </textarea>
        <div class="reply-actions">
          <button class="btn-cancel" (click)="cancelReply(review._id)" [disabled]="submittingReply">
            Cancel
          </button>
          <button class="btn-submit" (click)="submitReply(review)" [disabled]="submittingReply || !replyText[review._id]?.trim()">
            {{ submittingReply ? 'Sending...' : 'Send Reply' }}
          </button>
        </div>
      </div>
      
      <!-- Reply Button (only if no reply exists) -->
      <button 
        class="btn-reply" 
        *ngIf="(!review.replies || review.replies.length === 0) && replyingToReview !== review._id"
        (click)="startReply(review._id)">
        <lucide-icon [img]="MessageSquare" [size]="16"></lucide-icon>
        <span>Reply as Business</span>
      </button>
    </div>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="!loadingReviews && filteredReviews.length === 0 && !loadingBusinesses">
    <lucide-icon [img]="MessageSquare" [size]="64"></lucide-icon>
    <h3>No Reviews Found</h3>
    <p *ngIf="searchQuery || selectedBusiness !== 'all' || selectedStatus !== 'all'">
      Try adjusting your filters
    </p>
    <p *ngIf="!searchQuery && selectedBusiness === 'all' && selectedStatus === 'all'">
      Reviews for your businesses will appear here
    </p>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="loadingReviews || loadingBusinesses">
    <div class="spinner"></div>
    <p>Loading reviews...</p>
  </div>
</div>
