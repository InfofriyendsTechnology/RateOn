<div class="reviews-page">

  <!-- ── Header Card ───────────────────────────────── -->
  <div class="reviews-header">
    <div class="header-left">
      <div class="header-icon">
        <lucide-icon [img]="Star" [size]="22"></lucide-icon>
      </div>
      <div class="header-text">
        <h1>Review Management</h1>
        <p class="subtitle" *ngIf="getPendingRepliesCount() > 0">
          <span class="pending-pill">{{ getPendingRepliesCount() }}</span>
          pending repl{{ getPendingRepliesCount() > 1 ? 'ies' : 'y' }}
        </p>
        <p class="subtitle all-read" *ngIf="getPendingRepliesCount() === 0 && !loadingReviews">
          <span class="check-badge"><lucide-icon [img]="Check" [size]="11"></lucide-icon></span>
          All reviews replied
        </p>
        <p class="subtitle" *ngIf="loadingReviews">Loading reviews...</p>
      </div>
    </div>
  </div>

  <!-- ── Toolbar ───────────────────────────────────── -->
  <div class="reviews-toolbar">
    <div class="filter-tabs">
      <button class="filter-tab" [class.active]="selectedStatus === 'all'" (click)="selectedStatus = 'all'; applyFilters()">
        <lucide-icon [img]="MessageSquare" [size]="13"></lucide-icon>
        All
        <span class="badge-count" *ngIf="reviews.length > 0">{{ reviews.length }}</span>
      </button>
      <button class="filter-tab" [class.active]="selectedStatus === 'pending'" (click)="selectedStatus = 'pending'; applyFilters()">
        <lucide-icon [img]="Clock" [size]="13"></lucide-icon>
        Pending
        <span class="badge-hot" *ngIf="getPendingRepliesCount() > 0">{{ getPendingRepliesCount() }}</span>
      </button>
      <button class="filter-tab" [class.active]="selectedStatus === 'replied'" (click)="selectedStatus = 'replied'; applyFilters()">
        <lucide-icon [img]="CheckCheck" [size]="13"></lucide-icon>
        Replied
        <span class="badge-count" *ngIf="getRepliedCount() > 0">{{ getRepliedCount() }}</span>
      </button>
    </div>
    <div class="toolbar-right">
      <div class="biz-select-wrap">
        <lucide-icon [img]="ShoppingBag" [size]="14"></lucide-icon>
        <select [(ngModel)]="selectedBusiness" (change)="onBusinessFilterChange()" class="biz-select">
          <option value="all">All Businesses</option>
          <option *ngFor="let business of businesses" [value]="business._id">{{ business.name }}</option>
        </select>
        <lucide-icon [img]="ChevronDown" [size]="14"></lucide-icon>
      </div>
      <div class="search-wrap">
        <lucide-icon [img]="Search" [size]="14"></lucide-icon>
        <input type="text" placeholder="Search reviews..." [(ngModel)]="searchQuery" (input)="onSearchChange()" class="search-input" />
      </div>
    </div>
  </div>

  <!-- ── Skeleton Loader ───────────────────────────── -->
  <div class="review-card-wrap" *ngIf="loadingReviews || loadingBusinesses">
    <div class="skeleton-item" *ngFor="let i of [1,2,3,4]">
      <div class="skel skel-accent"></div>
      <div class="skel skel-avatar"></div>
      <div class="skel-body">
        <div class="skel skel-line long"></div>
        <div class="skel skel-line short"></div>
        <div class="skel skel-line medium"></div>
      </div>
    </div>
  </div>

  <!-- ── Empty State ───────────────────────────────── -->
  <div class="reviews-empty" *ngIf="!loadingReviews && !loadingBusinesses && filteredReviews.length === 0">
    <div class="empty-icon-wrap">
      <lucide-icon [img]="Star" [size]="30"></lucide-icon>
    </div>
    <h3>No Reviews Found</h3>
    <p *ngIf="searchQuery || selectedBusiness !== 'all' || selectedStatus !== 'all'">Try adjusting your filters</p>
    <p *ngIf="!searchQuery && selectedBusiness === 'all' && selectedStatus === 'all'">Reviews for your businesses will appear here</p>
  </div>

  <!-- ── Review List ────────────────────────────────── -->
  <div class="review-card-wrap" *ngIf="!loadingReviews && !loadingBusinesses && filteredReviews.length > 0">
    <div class="review-item" *ngFor="let review of filteredReviews" [id]="'review-' + review._id">

      <!-- Left accent bar -->
      <span class="accent-bar" [class]="getRatingClass(review.rating)"></span>

      <!-- Avatar -->
      <div class="r-avatar">
        <img
          *ngIf="getAvatarUrl(review) && !avatarFailed[review._id]"
          [src]="getAvatarUrl(review)"
          [alt]="getUserDisplayName(review)"
          crossorigin="anonymous"
          referrerpolicy="no-referrer"
          (error)="onAvatarError(review._id)"
        />
        <span *ngIf="!getAvatarUrl(review) || avatarFailed[review._id]" class="r-initial">
          {{ getUserDisplayName(review).charAt(0).toUpperCase() }}
        </span>
        <span class="r-rating-badge" [class]="getRatingClass(review.rating)">{{ review.rating }}★</span>
      </div>

      <!-- Content -->
      <div class="r-content">

        <!-- Name + meta -->
        <div class="r-top">
          <div class="r-user">
            <button class="r-name" (click)="viewUserProfile(review)">{{ getUserDisplayName(review) }}</button>
          </div>
          <div class="r-meta">
            <div class="rating-stars">
              <span *ngFor="let i of [1,2,3,4,5]" class="star"
                [class.filled]="i <= review.rating"
                [class.empty]="i > review.rating">★</span>
            </div>
            <span class="r-sep">·</span>
            <span class="r-time">{{ getTimeAgo(review.createdAt) }}</span>
            <span class="r-sep">·</span>
            <span class="r-biz">
              <lucide-icon [img]="ShoppingBag" [size]="11"></lucide-icon>
              {{ review.businessInfo?.name }}
            </span>
          </div>
        </div>

        <!-- Review text -->
        <p class="r-text">{{ review.reviewText || review.comment }}</p>

        <!-- Images -->
        <div class="r-images" *ngIf="review.images?.length > 0">
          <img *ngFor="let img of review.images.slice(0, 3)" [src]="img" alt="Review photo" class="r-img" />
        </div>

        <!-- Reactions -->
        <div class="r-reactions">
          <app-reaction-buttons
            [reviewId]="review._id"
            [reviewOwnerId]="getReviewOwnerId(review)"
            [initialStats]="{
              helpful: review.reactions?.helpful || 0,
              notHelpful: review.reactions?.notHelpful || 0,
              total: (review.reactions?.helpful || 0) + (review.reactions?.notHelpful || 0)
            }"
            [compact]="true"
            (reactionChanged)="onReactionChanged(review, $event)">
          </app-reaction-buttons>
        </div>

        <!-- Existing reply -->
        <div class="r-reply-display" *ngIf="review.replies?.length > 0">
          <div class="reply-label">
            <lucide-icon [img]="Reply" [size]="12"></lucide-icon>
            <span>Your Reply</span>
          </div>
          <p class="reply-text">{{ review.replies[0].comment || review.replies[0].text }}</p>
          <span class="reply-time">{{ getTimeAgo(review.replies[0].createdAt) }}</span>
        </div>

        <!-- Reply form -->
        <div class="r-reply-form" *ngIf="replyingToReview === review._id">
          <textarea
            class="reply-input"
            [(ngModel)]="replyText[review._id]"
            placeholder="Write your reply as business owner..."
            rows="3"
            [disabled]="submittingReply">
          </textarea>
          <div class="reply-form-actions">
            <button class="btn-cancel" (click)="cancelReply(review._id)" [disabled]="submittingReply">Cancel</button>
            <button class="btn-submit-reply" (click)="submitReply(review)" [disabled]="submittingReply || !replyText[review._id]?.trim()">
              {{ submittingReply ? 'Sending...' : 'Send Reply' }}
            </button>
          </div>
        </div>

        <!-- Action buttons -->
        <div class="r-actions">
          <button
            class="btn-reply-start"
            *ngIf="(!review.replies || review.replies.length === 0) && replyingToReview !== review._id"
            (click)="startReply(review._id)">
            <lucide-icon [img]="Reply" [size]="13"></lucide-icon>
            Reply
          </button>
          <button class="btn-view" (click)="viewReview(review)">
            <lucide-icon [img]="ExternalLink" [size]="13"></lucide-icon>
            View
          </button>
          <span class="r-replied-badge" *ngIf="review.replies?.length > 0">
            <lucide-icon [img]="CheckCheck" [size]="12"></lucide-icon>
            Replied
          </span>
        </div>

      </div>
    </div>
  </div>

</div>
