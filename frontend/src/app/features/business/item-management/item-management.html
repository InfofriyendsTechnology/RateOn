<div class="items-page">

  <!-- ── Header Card ── -->
  <div class="page-header-card">
    <div class="header-left">
      <div class="header-icon">
        <lucide-icon [img]="Package" [size]="22"></lucide-icon>
      </div>
      <div class="header-text">
        <h1>{{ business?.name || 'Manage Items' }}</h1>
        <p class="subtitle">{{ items.length }} item{{ items.length !== 1 ? 's' : '' }}</p>
      </div>
    </div>
    <div class="header-right" *ngIf="businessId">
      <button class="btn-add" (click)="openAddModal()">
        <lucide-icon [img]="Plus" [size]="16"></lucide-icon>
        Add Item
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-container" *ngIf="loading">
    <div class="spinner"></div>
    <p>Loading items...</p>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="!loading && items.length === 0">
    <div class="empty-icon-wrap">
      <lucide-icon [img]="Package" [size]="32"></lucide-icon>
    </div>
    <h3>No Items Yet</h3>
    <p>Start adding items to your menu.</p>
    <button *ngIf="businessId" (click)="openAddModal()" class="btn-create">
      <lucide-icon [img]="Plus" [size]="16"></lucide-icon>
      Add Your First Item
    </button>
  </div>

  <!-- Items Grid -->
  <div class="items-grid" *ngIf="!loading && items.length > 0">
    <div *ngFor="let item of items" class="item-card">

      <!-- Image -->
      <div class="item-image">
        <ng-container *ngIf="hasImage(item) && !imageLoadFailed[item._id]; else noImgTpl">
          <img [src]="getItemImage(item)" [alt]="item.name" (error)="onItemImageError(item)">
        </ng-container>
        <ng-template #noImgTpl>
          <div class="no-image">
            <lucide-icon [img]="ImageIcon" [size]="26"></lucide-icon>
            <span>No image</span>
          </div>
        </ng-template>
        <div class="price-badge">
          <lucide-icon [img]="IndianRupee" [size]="11"></lucide-icon>
          {{ item.price }}
        </div>
      </div>

      <!-- Info -->
      <div class="item-info">
        <div class="item-header">
          <h3>{{ item.name }}</h3>
          <span class="cat-badge" *ngIf="item.category">{{ item.category }}</span>
        </div>
        <p class="item-desc" *ngIf="item.description">{{ item.description }}</p>

        <!-- Stats -->
        <div class="item-stats">
          <span class="istat">
            <lucide-icon [img]="Star" [size]="12"></lucide-icon>
            {{ ($any(item).stats?.averageRating || 0) | number:'1.1-1' }}
          </span>
          <span class="istat">
            <lucide-icon [img]="MessageSquare" [size]="12"></lucide-icon>
            {{ $any(item).stats?.totalReviews || 0 }} reviews
          </span>
        </div>

        <!-- Actions -->
        <div class="item-actions">
          <button (click)="openEditModal(item)" class="btn-edit">
            <lucide-icon [img]="Edit2" [size]="13"></lucide-icon>
            Edit
          </button>
          <button (click)="deleteItem(item)" class="btn-del">
            <lucide-icon [img]="Trash2" [size]="13"></lucide-icon>
          </button>
        </div>
      </div>

    </div>
  </div>

</div>

<!-- Add / Edit Modal -->
<div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
  <div class="modal-box" (click)="$event.stopPropagation()">

    <div class="modal-head">
      <div class="modal-head-left">
        <div class="modal-icon">
          <lucide-icon [img]="editMode ? Edit2 : Plus" [size]="15"></lucide-icon>
        </div>
        <h3>{{ editMode ? 'Edit' : 'Add' }} Item</h3>
      </div>
      <button (click)="closeModal()" class="modal-close">
        <lucide-icon [img]="X" [size]="18"></lucide-icon>
      </button>
    </div>

    <div class="modal-body">
      <form>
        <div class="form-group">
          <label>Name <span class="req">*</span></label>
          <input [(ngModel)]="itemForm.name" name="name" placeholder="Item name" class="form-input">
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea [(ngModel)]="itemForm.description" name="description" placeholder="Short description..." class="form-input" rows="2"></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Price (Rs.) <span class="req">*</span></label>
            <input [(ngModel)]="itemForm.price" name="price" type="number" placeholder="0" class="form-input" min="0">
          </div>
          <div class="form-group">
            <label>Category</label>
            <input [(ngModel)]="itemForm.category" name="category" placeholder="e.g. Snacks" class="form-input">
          </div>
        </div>

        <div class="form-group">
          <label>Photos</label>
          <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*" multiple hidden>
          <button type="button" (click)="fileInput.click()" class="btn-upload">
            <lucide-icon [img]="Upload" [size]="15"></lucide-icon>
            Upload Images
          </button>
          <div class="image-previews" *ngIf="imagePreviewUrls.length > 0">
            <div *ngFor="let url of imagePreviewUrls; let i = index" class="preview-item">
              <img [src]="url" alt="Preview">
              <button type="button" (click)="removeImage(i)" class="btn-remove">
                <lucide-icon [img]="X" [size]="12"></lucide-icon>
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>

    <div class="modal-foot">
      <button (click)="closeModal()" class="btn-modal-cancel" [disabled]="saving">Cancel</button>
      <button (click)="saveItem()" class="btn-modal-primary" [disabled]="saving">
        {{ saving ? 'Saving...' : (editMode ? 'Update' : 'Add') + ' Item' }}
      </button>
    </div>

  </div>
</div>
